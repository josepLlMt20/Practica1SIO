<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="neighbourhoodsBCN.js"></script> <!-- Archivo GeoJSON de Barcelona -->
    <script src="neighbourhoodsBerlin.js"></script> <!-- Archivo GeoJSON de Berlín -->
    <script src="neighbourhoodsBUA.js"></script> <!-- Archivo GeoJSON de Buenos Aires -->
    <meta charset="UTF-8">
    <title>Multi-City Maps with Prices</title>
</head>
<body>
    <div id="map" style="height: 100vh;"></div>
    <script>
        // Crear el mapa con vista global
        var map = L.map('map').setView([20.0, 0.0], 2);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Función para calcular el precio promedio por barrio
        function calculateAveragePricePerNeighbourhood(data, neighbourhoodField) {
            var pricesByNeighbourhood = {};

            data.forEach(function(entry) {
                var neighbourhoodGroup = entry[neighbourhoodField]; // Ajustamos el campo según la ciudad
                var price = parseFloat(entry.price);

                if (!isNaN(price)) {
                    if (!pricesByNeighbourhood[neighbourhoodGroup]) {
                        pricesByNeighbourhood[neighbourhoodGroup] = [];
                    }
                    pricesByNeighbourhood[neighbourhoodGroup].push(price);
                }
            });

            var averagePrices = {};
            for (var neighbourhood in pricesByNeighbourhood) {
                var total = pricesByNeighbourhood[neighbourhood].reduce((sum, price) => sum + price, 0);
                var count = pricesByNeighbourhood[neighbourhood].length;
                averagePrices[neighbourhood] = total / count;
            }

            return averagePrices;
        }

        // Función para asignar colores según el precio promedio
        function getColor(d) {
            return d > 300 ? '#800026' :
                   d > 250 ? '#BD0026' :
                   d > 200 ? '#E31A1C' :
                   d > 150  ? '#FC4E2A' :
                   d > 100  ? '#FD8D3C' :
                             '#FFEDA0';
        }

        // Función para estilizar los barrios según el precio promedio
        function style(feature, averagePrices, cityField) {
            var price = averagePrices[feature.properties[cityField]];
            if (typeof price === 'undefined') {
                price = 0; // Asignar 0 si no hay precio disponible
            }
            return {
                fillColor: getColor(price),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        // Crear capas para cada ciudad
        var barcelonaLayer = L.layerGroup();
        var berlinLayer = L.layerGroup();
        var buenosAiresLayer = L.layerGroup();

        // Función para procesar cada ciudad
        function processCity(csvUrl, geoJsonData, layerGroup, neighbourhoodFieldCsv, neighbourhoodFieldJson) {
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                     console.log(results.data);
                    var averagePrices = calculateAveragePricePerNeighbourhood(results.data, neighbourhoodFieldCsv); // Usamos el campo adecuado

                    console.log(averagePrices);
                    var geoLayer = L.geoJSON(geoJsonData, {
                        style: function(feature) {
                            return style(feature, averagePrices, neighbourhoodFieldJson); // Pasamos el campo adecuado
                        }
                    });

                    layerGroup.addLayer(geoLayer);
                }
            });
        }

        // Cargar los datos y añadir a cada capa con los campos correctos para cada ciudad
        processCity('CityFiles/barcelona/transformado.csv', geoJsonBCN, barcelonaLayer, 'neighbourhood_group_cleansed', 'neighbourhood_group');
        processCity('CityFiles/berlin/transformado.csv', geoJsonBerlin, berlinLayer, 'neighbourhood_group_cleansed', 'neighbourhood_group');
        processCity('CityFiles/buenos aires/transformado.csv', geoJsonBuenosAires, buenosAiresLayer, 'neighbourhood_cleansed', 'neighbourhood');

        // Añadir capas de ciudades al mapa
        var overlayMaps = {
            "Barcelona": barcelonaLayer,
            "Berlin": berlinLayer,
            "Buenos Aires": buenosAiresLayer
        };

        // Añadir control de capas
        L.control.layers(null, overlayMaps).addTo(map);

        // Activar las tres capas por defecto
        barcelonaLayer.addTo(map);
        berlinLayer.addTo(map);
        buenosAiresLayer.addTo(map);
    </script>
</body>
</html>
