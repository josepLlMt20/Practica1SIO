<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Añadir biblioteca para clústeres -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="neighbourhoodsBCN.js"></script> <!-- Archivo GeoJSON de Barcelona -->
    <script src="neighbourhoodsBerlin.js"></script> <!-- Archivo GeoJSON de Berlín -->
    <script src="neighbourhoodsBUA.js"></script> <!-- Archivo GeoJSON de Buenos Aires -->
    <meta charset="UTF-8">
    <title>Multi-City Maps with Prices</title>
</head>
<body>
    <div id="map" style="height: 100vh;"></div>
    <script>
        var map = L.map('map').setView([20.0, 0.0], 2);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        function calculateAveragePricePerNeighbourhood(data, neighbourhoodField) {
            var pricesByNeighbourhood = {};

            data.forEach(function(entry) {
                var neighbourhoodGroup = entry[neighbourhoodField];
                var price = parseFloat(entry.price);

                if (!isNaN(price)) {
                    if (!pricesByNeighbourhood[neighbourhoodGroup]) {
                        pricesByNeighbourhood[neighbourhoodGroup] = [];
                    }
                    pricesByNeighbourhood[neighbourhoodGroup].push(price);
                }
            });

            var averagePrices = {};
            for (var neighbourhood in pricesByNeighbourhood) {
                var total = pricesByNeighbourhood[neighbourhood].reduce((sum, price) => sum + price, 0);
                var count = pricesByNeighbourhood[neighbourhood].length;
                averagePrices[neighbourhood] = total / count;
            }

            return averagePrices;
        }

        function getColor(d, city) {
            if (city === "Buenos Aires") {
                return d > 250000 ? '#800026' :
                       d > 200000 ? '#BD0026' :
                       d > 150000 ? '#E31A1C' :
                       d > 100000 ? '#FC4E2A' :
                       d > 50000 ? '#FD8D3C' :
                                  '#FFEDA0';
            } else {
                return d > 300 ? '#800026' :
                       d > 250 ? '#BD0026' :
                       d > 200 ? '#E31A1C' :
                       d > 150  ? '#FC4E2A' :
                       d > 100  ? '#FD8D3C' :
                                  '#FFEDA0';
            }
        }

        function style(feature, averagePrices, cityField, city) {
            var price = averagePrices[feature.properties[cityField]];
            if (typeof price === 'undefined') {
                price = 0;
            }
            return {
                fillColor: getColor(price, city),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        // Crear grupos de clústeres para cada ciudad
        var airbnbCluster = L.markerClusterGroup();
        var geoLayerGroup = L.layerGroup(); // Grupo para las capas de precios promedio

        function processCity(csvUrl, geoJsonData, neighbourhoodFieldCsv, neighbourhoodFieldJson, cityName) {
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    var averagePrices = calculateAveragePricePerNeighbourhood(results.data, neighbourhoodFieldCsv);

                    // Añadir capa GeoJSON al grupo
                    var geoLayer = L.geoJSON(geoJsonData, {
                        style: function(feature) {
                            return style(feature, averagePrices, neighbourhoodFieldJson, cityName);
                        }
                    });

                    geoLayerGroup.addLayer(geoLayer);

                    // Añadir marcadores a clúster
                    results.data.forEach(function(entry) {
                        var lat = parseFloat(entry.latitude);
                        var lon = parseFloat(entry.longitude);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            var marker = L.marker([lat, lon]).bindPopup(`Price: $${entry.price}`);
                            airbnbCluster.addLayer(marker);
                        }
                    });
                }
            });
        }

        // Procesar las ciudades
        processCity('CityFiles/barcelona/transformado.csv', geoJsonBCN, 'neighbourhood_group_cleansed', 'neighbourhood_group', 'Barcelona');
        processCity('CityFiles/berlin/transformado.csv', geoJsonBerlin, 'neighbourhood_group_cleansed', 'neighbourhood_group', 'Berlin');
        processCity('CityFiles/buenos aires/transformado.csv', geoJsonBuenosAires, 'neighbourhood_cleansed', 'neighbourhood', 'Buenos Aires');

        // Añadir capas al mapa y controles de capa
        var overlayMaps = {
            "Average Prices": geoLayerGroup,
            "Airbnbs": airbnbCluster
        };

        L.control.layers(null, overlayMaps).addTo(map);
        geoLayerGroup.addTo(map); // Añadir capa de precios promedio al mapa
        airbnbCluster.addTo(map); // Añadir capa de clúster de Airbnb al mapa
    </script>
</body>
</html>
